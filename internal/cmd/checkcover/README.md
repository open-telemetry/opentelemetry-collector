# checkcover

A tool to validate code coverage requirements for OpenTelemetry Collector components based on their stability level and custom coverage settings.

## Overview

`checkcover` ensures that components meet minimum code coverage requirements as outlined in the [Component Stability](../../docs/component-stability.md) document.

### Coverage Requirements

- **Stable components**: Must have at least 80% coverage (or the repository minimum, whichever is higher)
- **Other stability levels**: No default minimum (unless specified in `metadata.yaml` or via repository minimum)
- **Custom minimums**: Components can specify a higher requirement via `coverage_minimum` in their `metadata.yaml`

## Usage

```bash
checkcover -c <coverage-file> -r <repo-root> [-m <repo-minimum>] [-v]
```

### Flags

- `-c, --coverage-file`: Path to the coverage file (default: `coverage.txt`)
- `-r, --repo-root`: Root directory of the repository (default: `.`)
- `-m, --repo-minimum`: Repository-wide minimum coverage percentage (default: `0`)
- `-v, --verbose`: Enable verbose output

### Examples

```bash
# Validate coverage with default settings
checkcover -c coverage.txt -r /path/to/repo

# Validate with repository minimum of 70%
checkcover -c coverage.txt -r /path/to/repo -m 70

# Validate with verbose output
checkcover -c coverage.txt -r /path/to/repo -v
```

## How It Works

1. **Load Coverage Data**: Parses the coverage file (generated by `go tool covdata textfmt`) to extract coverage percentages for each module.

2. **Find Components**: Scans the repository for `metadata.yaml` files to identify all components.

3. **Determine Requirements**: For each component:

   - Checks stability level from `metadata.yaml`
   - Applies 80% minimum for stable components
   - Uses repository minimum if higher
   - Uses component-specific `coverage_minimum` if higher

4. **Validate Coverage**: Compares actual coverage against required minimum and reports any failures.

## Integration with CI

The tool is integrated into the CI workflow in `.github/workflows/build-and-test.yml`:

```yaml
- name: Validate coverage requirements
  run: |
    cd cmd/checkcover
    go run . -c ../../coverage.txt -r ../.. -v
```

## Metadata Configuration

Components can specify a custom minimum coverage in their `metadata.yaml`:

```yaml
type: mycomponent
status:
  class: receiver
  stability:
    stable: [metrics, traces]
  coverage_minimum: 85 # Require 85% coverage (higher than the 80% default)
```

### Notes

- The `coverage_minimum` field is optional
- Setting it lower than the stability-based minimum has no effect
- Components can disable coverage badges entirely with `disable_codecov_badge: true`

## Development

### Building

```bash
go build -o checkcover .
```

### Testing

```bash
go test -v
```

## Exit Codes

- `0`: All components meet coverage requirements
- `1`: One or more components fail to meet requirements
