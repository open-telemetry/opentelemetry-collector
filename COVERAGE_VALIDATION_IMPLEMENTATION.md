# Implementation Summary: Code Coverage Validation for OpenTelemetry Collector Components

## Issue Reference

GitHub Issue: #14098 - Validate and enforce test coverage requirements

Parent Issue: #14066 - Automate validation and fulfillment of criteria outlined in the "Component Stability" document

## Overview

This implementation adds automated validation of code coverage requirements for OpenTelemetry Collector components based on their stability level, as outlined in the Component Stability document.

## What Was Implemented

### 1. Metadata Schema Enhancement (`cmd/mdatagen/metadata-schema.yaml`)

- Added optional `coverage_minimum` field under the `status` section
- Allows components to specify a minimum coverage requirement higher than the default
- Value must be between 0 and 100
- Setting it lower than stability-based minimum has no effect

```yaml
status:
  coverage_minimum: 85 # Optional: Require 85% coverage
```

### 2. Status Struct Update (`cmd/mdatagen/internal/status.go`)

- Added `CoverageMinimum` field to the `Status` struct
- Added validation to ensure the value is between 0 and 100
- Integrated validation into the existing `Validate()` method

### 3. Coverage Validation Tool (`cmd/checkcover/`)

Created a new command-line tool with the following components:

#### Files Created:

- `main.go` - CLI entry point with cobra command structure
- `validator.go` - Core validation logic
- `validator_test.go` - Unit tests
- `README.md` - Documentation
- `go.mod` - Go module definition
- `Makefile` - Build configuration

#### Features:

- **Coverage Parsing**: Reads and parses coverage.txt files (generated by `go tool covdata textfmt`)
- **Module Detection**: Automatically finds all components with metadata.yaml files
- **Threshold Calculation**: Determines minimum coverage based on:
  - Stability level (80% for stable components)
  - Repository-wide minimum (if specified)
  - Component-specific coverage_minimum (if specified)
- **Validation**: Compares actual coverage against required minimum
- **Detailed Reporting**: Shows which components pass or fail with specific percentages

#### Command-Line Interface:

```bash
checkcover -c coverage.txt -r /path/to/repo [-m repo-minimum] [-v]
```

Flags:

- `-c, --coverage-file`: Path to coverage file (default: "coverage.txt")
- `-r, --repo-root`: Repository root directory (default: ".")
- `-m, --repo-minimum`: Repository-wide minimum percentage (default: 0)
- `-v, --verbose`: Enable verbose output

### 4. CI Integration (`.github/workflows/build-and-test.yml`)

Added a new step to the `test-coverage` job:

```yaml
- name: Validate coverage requirements
  run: |
    cd cmd/checkcover
    go run . -c ../../coverage.txt -r ../.. -v
```

This runs after:

1. Tests are executed with coverage (`make gotest-with-cover`)
2. Coverage report is uploaded to Codecov

### 5. Existing Functionality Verified

- Confirmed that mdatagen already generates README sections with codecov badges
- The badge generation respects the `disable_codecov_badge` flag
- Component ID matching is handled via `GetCodeCovComponentID()` method

## Coverage Requirements

### Stable Components

- **Minimum**: 80% coverage
- **Override**: Can be increased via `coverage_minimum` in metadata.yaml
- **Repository Minimum**: Applied if higher than 80%

### Other Stability Levels (Alpha, Beta, Development)

- **Minimum**: No default requirement
- **Override**: Can set via `coverage_minimum` in metadata.yaml
- **Repository Minimum**: Applied if specified

### Calculation Priority

The tool uses the highest of:

1. Stability-based minimum (80% for stable, 0% for others)
2. Repository minimum (via `-m` flag)
3. Component-specific `coverage_minimum` (from metadata.yaml)

## Example Usage

### For a Stable Component

```yaml
# metadata.yaml
type: otlp
status:
  class: receiver
  stability:
    stable: [metrics, traces]
  # No coverage_minimum specified, uses 80% default
```

**Requirement**: 80% coverage

### For a Component with Custom Minimum

```yaml
# metadata.yaml
type: custom
status:
  class: processor
  stability:
    stable: [metrics]
  coverage_minimum: 90 # Higher than default
```

**Requirement**: 90% coverage

### For an Alpha Component

```yaml
# metadata.yaml
type: experimental
status:
  class: exporter
  stability:
    alpha: [metrics]
  coverage_minimum: 70 # Optional requirement for alpha
```

**Requirement**: 70% coverage (from coverage_minimum)

## Testing

### Unit Tests

- Coverage file parsing
- Minimum coverage calculation
- Module path resolution
- Coverage lookup and matching

### Integration with CI

- Runs automatically on every PR and commit
- Fails the build if any component doesn't meet requirements
- Provides clear error messages showing which components failed

## Benefits

1. **Automated Enforcement**: No manual checking required
2. **Clear Requirements**: Components know exactly what coverage they need
3. **Flexible Configuration**: Components can set higher standards if desired
4. **CI Integration**: Prevents merging code that doesn't meet coverage standards
5. **Visibility**: All components show coverage badges in their READMEs

## Future Enhancements

Potential improvements that could be made in the future:

1. **Beta/Alpha Requirements**: Consider adding default minimums for beta (e.g., 60%) and alpha (e.g., 40%) components
2. **Progressive Requirements**: Implement a feature flag system that gradually increases requirements as components mature
3. **Coverage Trends**: Track coverage changes over time and warn about decreases
4. **Exemptions**: Add ability to temporarily exempt specific files or packages from coverage requirements
5. **HTML Reports**: Generate detailed HTML reports showing coverage by component

## Files Changed

1. `cmd/mdatagen/metadata-schema.yaml` - Added coverage_minimum field
2. `cmd/mdatagen/internal/status.go` - Added CoverageMinimum field and validation
3. `cmd/checkcover/main.go` - New file (CLI entry point)
4. `cmd/checkcover/validator.go` - New file (validation logic)
5. `cmd/checkcover/validator_test.go` - New file (tests)
6. `cmd/checkcover/README.md` - New file (documentation)
7. `cmd/checkcover/go.mod` - New file (dependencies)
8. `cmd/checkcover/Makefile` - New file (build config)
9. `.github/workflows/build-and-test.yml` - Added coverage validation step

## Related Documentation

- [Component Stability](../../docs/component-stability.md) - Requirements for stable components
- [checkcover README](../checkcover/README.md) - Tool documentation
- [mdatagen README](../mdatagen/README.md) - Metadata generator documentation

## Conclusion

This implementation provides a complete solution for validating and enforcing code coverage requirements across all OpenTelemetry Collector components. It automates a critical aspect of the component stability criteria and ensures that stable components maintain the required 80% coverage threshold.
