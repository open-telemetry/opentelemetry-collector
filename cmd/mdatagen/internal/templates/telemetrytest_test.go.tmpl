// Code generated by mdatagen. DO NOT EDIT.

package {{ .Package }}test

import (
    "context"
	"testing"

	"github.com/stretchr/testify/require"
	"go.opentelemetry.io/otel/sdk/metric/metricdata"
	"go.opentelemetry.io/otel/sdk/metric/metricdata/metricdatatest"
)

func TestSetupTelemetry(t *testing.T) {
	testTel := SetupTelemetry()
	tb, err := {{ .Package }}.NewTelemetryBuilder(
	    testTel.NewTelemetrySettings(),
        {{- $package := .Package -}}
        {{- range $name, $metric := .Telemetry.Metrics }}
        {{- if (and (not $metric.Optional) $metric.Data.Async) }}
        {{ $package }}.With{{ $name.Render }}Callback(func() {{ $metric.Data.BasicType }} { return 1 }),
        {{- end }}
        {{- end }}
    )
	require.NoError(t, err)
	require.NotNil(t, tb)
    {{- range $name, $metric := .Telemetry.Metrics }}
        {{- if (and (not $metric.Optional) (not $metric.Data.Async)) }}
            {{- if eq $metric.Data.Type "Sum" }}
            	tb.{{ $name.Render }}.Add(context.Background(), 1)
            {{- else }}
            	tb.{{ $name.Render }}.Record(context.Background(), 1)
            {{- end }}
        {{- end }}
    {{- end }}

    testTel.AssertMetrics(t, []metricdata.Metrics{
    {{- range $name, $metric := .Telemetry.Metrics }}
        {{- if not $metric.Optional }}
        {
            Name: "otelcol_{{ $name }}",
            Description: "{{ $metric.Description }}{{ $metric.Stability }}",
            Unit: "{{ $metric.Unit }}",
            {{ if eq $metric.Data.Type "Gauge" -}}
			Data: metricdata.Gauge[{{ $metric.Gauge.MetricValueType.BasicType }}]{
				DataPoints: []metricdata.DataPoint[{{ $metric.Gauge.MetricValueType.BasicType }}]{
					{},
				},
			},
            {{- else if eq $metric.Data.Type "Sum" -}}
			Data: metricdata.Sum[{{ $metric.Sum.MetricValueType.BasicType }}]{
				Temporality: metricdata.CumulativeTemporality,
				IsMonotonic: {{ $metric.Sum.Mono.Monotonic }},
				DataPoints: []metricdata.DataPoint[{{ $metric.Sum.MetricValueType.BasicType }}]{
					{},
				},
			},
            {{- else if eq $metric.Data.Type "Histogram" -}}
			Data: metricdata.Histogram[{{ $metric.Histogram.MetricValueType.BasicType }}]{
				Temporality: metricdata.CumulativeTemporality,
				DataPoints: []metricdata.HistogramDataPoint[{{ $metric.Histogram.MetricValueType.BasicType }}]{
					{},
				},
			},
            {{- end }}
        },
        {{- end }}
    {{- end }}
    }, metricdatatest.IgnoreTimestamp(), metricdatatest.IgnoreValue())

    {{- range $name, $metric := .Telemetry.Metrics }}
    {{ if not $metric.Optional }}
    AssertEqual{{ $name.Render }}(t, testTel.Telemetry,
        {{ if eq $metric.Data.Type "Gauge" -}}
        []metricdata.DataPoint[{{ $metric.Gauge.MetricValueType.BasicType }}]{{"{{}}"}},
        {{- else if eq $metric.Data.Type "Sum" -}}
        []metricdata.DataPoint[{{ $metric.Sum.MetricValueType.BasicType }}]{{"{{}}"}},
        {{- else if eq $metric.Data.Type "Histogram" -}}
        []metricdata.HistogramDataPoint[{{ $metric.Histogram.MetricValueType.BasicType }}]{{"{{}}"}},
        {{- end }}
        metricdatatest.IgnoreTimestamp(), metricdatatest.IgnoreValue())
    {{- end }}
    {{- end }}

	require.NoError(t, testTel.Shutdown(context.Background()))
}
