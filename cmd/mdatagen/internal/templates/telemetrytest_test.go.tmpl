// Code generated by mdatagen. DO NOT EDIT.

package {{ .Package }}test

import (
    "context"
	"testing"

	"github.com/stretchr/testify/require"
	"go.opentelemetry.io/otel/sdk/metric/metricdata"
	"go.opentelemetry.io/otel/sdk/metric/metricdata/metricdatatest"
)

func TestSetupTelemetry(t *testing.T) {
	testTel := SetupTelemetry()
	tb, err := {{ .Package }}.NewTelemetryBuilder(testTel.NewTelemetrySettings())
    require.NoError(t, err)
	defer tb.Shutdown()

    {{- range $name, $metric := .Telemetry.Metrics }}
    {{- if $metric.Data.Async }}
    require.NoError(t, tb.Register{{ $name.Render }}Callback(func(_ context.Context, observer metric.{{ casesTitle $metric.Data.BasicType }}Observer) error {
        observer.Observe(1)
        return nil
    }))
    {{- end }}
    {{- end }}

    {{- range $name, $metric := .Telemetry.Metrics }}
        {{- if not $metric.Data.Async }}
            {{- if eq $metric.Data.Type "Sum" }}
            	tb.{{ $name.Render }}.Add(context.Background(), 1)
            {{- else }}
            	tb.{{ $name.Render }}.Record(context.Background(), 1)
            {{- end }}
        {{- end }}
    {{- end }}

    testTel.AssertMetrics(t, []metricdata.Metrics{
    {{- range $name, $metric := .Telemetry.Metrics }}
        {
            Name: "otelcol_{{ $name }}",
            Description: "{{ $metric.Description }}{{ $metric.Stability }}",
            Unit: "{{ $metric.Unit }}",
            {{ if eq $metric.Data.Type "Gauge" -}}
			Data: metricdata.Gauge[{{ $metric.Gauge.MetricValueType.BasicType }}]{
				DataPoints: []metricdata.DataPoint[{{ $metric.Gauge.MetricValueType.BasicType }}]{
					{},
				},
			},
            {{- else if eq $metric.Data.Type "Sum" -}}
			Data: metricdata.Sum[{{ $metric.Sum.MetricValueType.BasicType }}]{
				Temporality: metricdata.CumulativeTemporality,
				IsMonotonic: {{ $metric.Sum.Mono.Monotonic }},
				DataPoints: []metricdata.DataPoint[{{ $metric.Sum.MetricValueType.BasicType }}]{
					{},
				},
			},
            {{- else if eq $metric.Data.Type "Histogram" -}}
			Data: metricdata.Histogram[{{ $metric.Histogram.MetricValueType.BasicType }}]{
				Temporality: metricdata.CumulativeTemporality,
				DataPoints: []metricdata.HistogramDataPoint[{{ $metric.Histogram.MetricValueType.BasicType }}]{
					{},
				},
			},
            {{- end }}
        },
    {{- end }}
    }, metricdatatest.IgnoreTimestamp(), metricdatatest.IgnoreValue())

    {{- range $name, $metric := .Telemetry.Metrics }}
    AssertEqual{{ $name.Render }}(t, testTel.Telemetry,
        {{ if eq $metric.Data.Type "Gauge" -}}
        []metricdata.DataPoint[{{ $metric.Gauge.MetricValueType.BasicType }}]{{"{{Value: 1}}"}},
        {{- else if eq $metric.Data.Type "Sum" -}}
        []metricdata.DataPoint[{{ $metric.Sum.MetricValueType.BasicType }}]{{"{{Value: 1}}"}},
        {{- else if eq $metric.Data.Type "Histogram" -}}
        []metricdata.HistogramDataPoint[{{ $metric.Histogram.MetricValueType.BasicType }}]{{"{{}}"}}, metricdatatest.IgnoreValue(),
        {{- end }}
        metricdatatest.IgnoreTimestamp())
    {{- end }}

	require.NoError(t, testTel.Shutdown(context.Background()))
}
